pipeline {
    
        environment {
        registry = "dotnetdemo.azurecr.io/demoapp"
        registryCredential = 'azureacrid'
        dockerImage = ''
    }
    
    agent {label 'dotnet-slave'}
  
    stages {
        stage('Checkout Master branch') {
            steps {
                git branch: 'Dev', changelog: false, credentialsId: 'Github', poll: false, url: 'https://github.com/sandeep4642/dotnetdemo.git'
            }
        }
    stage ('Build') {
            steps {
                sh 'dotnet build'
            }
        }
    stage ('Build Docker image') {
            steps {
                script {
                  dockerImage = docker.build registry + ":$BUILD_NUMBER"
            } 
            }
        }
    stage('Deploy our image into Registry') {
            steps {
                script {
                    docker.withRegistry( 'https://dotnetdemo.azurecr.io', registryCredential ) {
                        dockerImage.push()
                    }
                } 
            }
        }
    stage('Remove Unused docker image') {
             steps{
             sh "docker rmi $registry:$BUILD_NUMBER"
            }
        }
    stage('Deploy App') {
      steps {
        script {
          sh "sed -i 's/latest/$BUILD_NUMBER/' deployment.yaml"
          kubernetesDeploy(configs: "deployment.yaml", kubeconfigId: "k8scluster")
        }
      }
    }    
    }
}
